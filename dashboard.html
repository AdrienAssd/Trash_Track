<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport">
    <title>Dashboard - TrashTrack</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="images/Logo_TrashTrack.png" alt="TrashTrack" class="logo-img">
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Accueil</a>
                <a href="/dashboard.html" class="nav-link active">Dashboard</a>
                <a href="/apropos.html" class="nav-link">√Ä propos</a>
                <a href="/historique" class="nav-link">Historique</a>
                <a href="/contact.html" class="nav-link">Contact</a>
            </nav>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="dashboard-grid">
                <!-- Carte -->
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">üó∫Ô∏è</span>
                        Localisation des Poubelles
                    </h2>
                    <div class="filter-controls">
                        <select class="filter-select" id="locationFilter">
                            <option value="all">Toutes les zones</option>
                            <option value="high-risk">Zones √† haut risque</option>
                            <option value="medium-risk">Zones √† risque moyen</option>
                            <option value="low-risk">Zones √† faible risque</option>
                        </select>
                        <div class="date-range">
                            <label>Du:</label>
                            <input type="date" class="date-input" id="startDate" value="2025-06-01">
                            <label>Au:</label>
                            <input type="date" class="date-input" id="endDate" value="2025-12-31">
                        </div>
                    </div>
                    <div id="map"></div>
                    <div class="risk-zones">
                        <h3>Zones √† Risque de D√©bordement</h3>
                        <div id="riskZonesList" style="max-height: 500px; overflow-y: auto; padding-right: 8px;"></div>
                    </div>
                </div>
                
                <!-- Statistiques -->
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">üìä</span>
                        Statistiques Globales
                    </h2>
                    <div class="upload-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-uploads">312</span>
                            <div class="stat-label">Images Upload√©es</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-bins">24</span>
                            <div class="stat-label">Poubelles Totales</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="avg-file-size">2.4 MB</span>
                            <div class="stat-label">Taille Moyenne</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number percentage-mixed" id="combined-percentage">67% / 33%</span>
                            <div class="stat-label">Vides / Pleines</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="binChart"></canvas>
                    </div>
                    
                    <!-- S√©parateur visuel -->
                    <div style="border-top: 1px solid #e0e0e0; margin: 20px 0;"></div>
                    
                    <!-- Titre pour la r√©partition g√©ographique -->
                    <h3 style="text-align: center; color: #666; margin-bottom: 15px; font-size: 14px;">
                        <span class="card-icon"></span>
                        R√©partition par Arrondissement
                    </h3>
                    
                    <div class="chart-container">
                        <canvas id="locationChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Graphiques d'analyse -->
            <div class="analytics-grid">
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">‚åõ</span>
                        √âvolution Temporelle des Poubelles
                    </h2>
                    <div class="filter-controls" style="margin-bottom: 15px;">
                        <select class="filter-select" id="timelineFilter" style="width: 200px;">
                            <option value="7">7 derniers jours</option>
                            <option value="14">14 derniers jours</option>
                            <option value="30" selected>30 derniers jours</option>
                            <option value="60">60 derniers jours</option>
                            <option value="90">90 derniers jours</option>
                        </select>
                    </div>
                    <div class="chart-container file-size-chart">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Historique -->
            <div class="dashboard-card history-section">
                <h2 class="card-title">
                    <span class="card-icon">üìã</span>
                    Historique des Images Trait√©es
                </h2>
                <div class="filter-controls">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">Tous les statuts</option>
                        <option value="empty">Vides uniquement</option>
                        <option value="full">Pleines uniquement</option>
                    </select>
                    <select class="filter-select" id="locationHistoryFilter">
                        <option value="all">Toutes les locations</option>
                        <option value="Paris 15e">Paris 15e</option>
                        <option value="Paris 16e">Paris 16e</option>
                        <option value="Paris 17e">Paris 17e</option>
                    </select>
                </div>
                <div class="history-list" id="historyList">
                        <!-- L'historique sera g√©n√©r√© dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="images/Logo_TrashTrack_Gris.png" alt="TrashTrack" class="logo-img">
                    </div>
                    <div class="social-icons">
                        <a href="https://github.com/AdrienAssd/Trash_Track" class="social-icon">
                            <img src="images/github_blanc.png" alt="GitHub" style="height: 24px; width: 24px;">
                        </a>
                        <a href="#" class="social-icon">üì∑</a>
                        <a href="#" class="social-icon">üé•‚Äã</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Notre √©quipe</h3>
                    <ul>
                        <li><a href="https://www.linkedin.com/in/alexandre-munier-a9a8a9251/">Alexandre MUNIER</a></li>
                        <li><a href="https://www.linkedin.com/in/thibault-bial/">Thibault BIAL</a></li>
                        <li><a href="https://www.linkedin.com/in/adrien-assouad-94a047252/">Adrien ASSOUAD</a></li>
                        <li><a href="https://www.linkedin.com/in/malo-clement-751666253/">Malo CLEMENT</a></li>
                        <li><a href="https://www.linkedin.com/in/fabio-scaramuzzino-314139252/">Fabio SCARAMUZZINO</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Technologies utilis√©es</h3>
                    <ul>
                        <li><a href="#">Python</a></li>
                        <li><a href="#">NumPy / Matplotlib / OpenCV</a></li>
                        <li><a href="#">HTML / CSS</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="Master_camp-Data_Final.pdf" target="_blank">PDF-Consigne</a></li>
                        <li><a href="https://github.com/AGhaziBla/Solution_Factory_Data/tree/main">GitHub-Consigne</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Variables globales pour stocker les donn√©es r√©elles
        let dashboardData = null;
        let binData = { empty: 0, full: 0 };
        let uploadStats = {};
        let fileSizeData = {};
        let timelineData = {};
        let locationData = {};
        let riskZones = [];
        let historyData = [];

        // Fonction pour charger les donn√©es depuis l'API
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                dashboardData = await response.json();
                
                // Mettre √† jour les variables globales avec les vraies donn√©es
                binData = {
                    empty: dashboardData.stats.emptyCount,
                    full: dashboardData.stats.fullCount
                };
                
                uploadStats = dashboardData.stats;
                fileSizeData = dashboardData.fileSizeData;
                timelineData = dashboardData.timelineData;
                locationData = dashboardData.locationData;
                
                riskZones = dashboardData.riskZones;
                historyData = dashboardData.historyData;
                
                console.log('Donn√©es du dashboard charg√©es:', dashboardData);
                return true;
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                // Utiliser des donn√©es par d√©faut en cas d'erreur
                initDefaultData();
                return false;
            }
        }

        // Donn√©es par d√©faut en cas d'erreur de chargement
        function initDefaultData() {
            binData = { empty: 0, full: 0 };
            uploadStats = {
                totalUploads: 0,
                totalBins: 0,
                avgFileSize: 0,
                emptyPercentage: 0,
                fullPercentage: 0
            };
            fileSizeData = {
                ranges: ['< 1MB', '1-2MB', '2-3MB', '3-4MB', '> 4MB'],
                counts: [0, 0, 0, 0, 0]
            };
            timelineData = {
                dates: [],
                uploads: [],
                emptyUploads: [],
                fullUploads: []
            };
            locationData = {
                locations: [],
                counts: []
            };
            riskZones = [];
            historyData = [];
        }

        let currentMap;
        let currentMarkers = [];
        let currentTimelineChart = null;
        let currentBinChart = null;
        let currentLocationChart = null;

        // Initialisation de la carte avec zones √† risque
        function initMap() {
            currentMap = L.map('map').setView([48.8566, 2.3522], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(currentMap);

            updateMapMarkers();
        }

        // Mise √† jour des marqueurs sur la carte
        function updateMapMarkers() {
            // Supprimer les anciens marqueurs
            currentMarkers.forEach(marker => currentMap.removeLayer(marker));
            currentMarkers = [];

            const locationFilter = document.getElementById('locationFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Filtrer les donn√©es selon les crit√®res
            let filteredData = historyData.filter(item => {
                const itemDate = item.timestamp.split(' ')[0];
                return itemDate >= startDate && itemDate <= endDate;
            });

            // Ajouter des marqueurs pour chaque poubelle
            filteredData.forEach(item => {
                const riskLevel = getRiskLevel(item.location);
                
                // Appliquer le filtre de zone √† risque seulement si ce n'est pas "all"
                if (locationFilter !== 'all' && !matchesRiskFilter(riskLevel, locationFilter)) {
                    return;
                }

                // D√©finir les couleurs et styles selon le statut (poubelle reste blanche)
                let backgroundColor = '';
                let borderColor = '';
                let shadowColor = '';
                let glowColor = '';
                
                if (item.status === 'full') {
                    // Rouge pour les poubelles pleines (fond seulement)
                    backgroundColor = 'linear-gradient(135deg, rgba(244, 67, 54, 0.25) 0%, rgba(244, 67, 54, 0.15) 100%)';
                    borderColor = '#f44336';
                    shadowColor = 'rgba(244, 67, 54, 0.5)';
                    glowColor = 'rgba(244, 67, 54, 0.3)';
                } else {
                    // Vert pour les poubelles vides (fond seulement)
                    backgroundColor = 'linear-gradient(135deg, rgba(76, 175, 80, 0.25) 0%, rgba(76, 175, 80, 0.15) 100%)';
                    borderColor = '#4CAF50';
                    shadowColor = 'rgba(76, 175, 80, 0.5)';
                    glowColor = 'rgba(76, 175, 80, 0.3)';
                }
                
                const icon = L.divIcon({
                    className: 'custom-marker-container',
                    html: `
                        <div class="marker-wrapper" style="
                            width: 46px; 
                            height: 46px; 
                            background: ${backgroundColor}; 
                            border: 3px solid ${borderColor}; 
                            border-radius: 50%; 
                            display: flex; 
                            align-items: center; 
                            justify-content: center;
                            box-shadow: 
                                0 8px 25px ${shadowColor}, 
                                0 4px 10px rgba(0,0,0,0.15),
                                inset 0 1px 3px rgba(255,255,255,0.3),
                                0 0 0 4px ${glowColor};
                            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                            backdrop-filter: blur(6px);
                            position: relative;
                            overflow: visible;
                        ">
                            <div class="marker-inner" style="
                                width: 32px;
                                height: 32px;
                                background: rgba(255, 255, 255, 0.95);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                            ">
                                <img src="static/images/poubelle-de-recyclage.png" 
                                     style="
                                         width: 22px; 
                                         height: 22px; 
                                         filter: brightness(0.3) contrast(1.5) drop-shadow(0 1px 3px rgba(0,0,0,0.5));
                                         transition: all 0.3s ease;
                                     ">
                            </div>
                            <div class="marker-pulse" style="
                                position: absolute;
                                top: -3px;
                                left: -3px;
                                right: -3px;
                                bottom: -3px;
                                border: 2px solid ${borderColor};
                                border-radius: 50%;
                                opacity: 0;
                                transform: scale(1);
                                animation: pulse 2s infinite ease-in-out;
                            "></div>
                        </div>`,
                    iconSize: [46, 46],
                    iconAnchor: [23, 23]
                });

                const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(currentMap);
                currentMarkers.push(marker);
                
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <strong>${item.location}</strong><br>
                        <span style="color: ${item.status === 'full' ? '#c62828' : '#2e7d32'}">
                            ${item.status === 'full' ? 'Pleine' : 'Vide'}
                        </span><br>
                        <small>${item.timestamp}</small><br>
                        <small>Taille: ${item.fileSize} MB</small><br>
                        <small>Fichier: ${item.filename}</small>
                    </div>
                `);
            });
            
            console.log(`Marqueurs affich√©s: ${currentMarkers.length}/${filteredData.length}`);
        }

        // Obtenir le niveau de risque pour une localisation
        function getRiskLevel(location) {
            const zone = riskZones.find(z => z.location === location);
            return zone ? zone.level : 'low';
        }

        // V√©rifier si le niveau de risque correspond au filtre
        function matchesRiskFilter(riskLevel, filter) {
            return filter === `${riskLevel}-risk`;
        }

        // Initialisation du graphique principal (donut)
        function initChart() {
            const ctx = document.getElementById('binChart').getContext('2d');
            
            // D√©truire le graphique existant s'il y en a un
            if (currentBinChart) {
                currentBinChart.destroy();
            }
            
            currentBinChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Vides', 'Pleines'],
                    datasets: [{
                        data: [binData.empty, binData.full],
                        backgroundColor: [
                            '#4CAF50',
                            '#FF5722'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialisation du graphique de r√©partition g√©ographique
        function initLocationChart() {
            const ctx = document.getElementById('locationChart').getContext('2d');
            
            // D√©truire le graphique existant s'il y en a un
            if (currentLocationChart) {
                currentLocationChart.destroy();
            }
            
            // G√©n√©ration de couleurs dynamiques pour les arrondissements
            const generateColors = (count) => {
                const colors = [];
                for (let i = 0; i < count; i++) {
                    const hue = (i * 137.508) % 360; // Nombre d'or pour une r√©partition harmonieuse
                    colors.push(`hsl(${hue}, 70%, 60%)`);
                }
                return colors;
            };
            
            currentLocationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: locationData.locations,
                    datasets: [{
                        data: locationData.counts,
                        backgroundColor: generateColors(locationData.locations.length),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Graphique d'√©volution temporelle avec trois courbes
        function initTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            // D√©truire le graphique existant s'il y en a un
            if (currentTimelineChart) {
                currentTimelineChart.destroy();
            }
            
            // Obtenir la p√©riode s√©lectionn√©e
            const selectedDays = parseInt(document.getElementById('timelineFilter').value);
            const filteredTimelineData = filterTimelineData(timelineData, selectedDays);
            
            currentTimelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredTimelineData.dates,
                    datasets: [{
                        label: 'Poubelles vides',
                        data: filteredTimelineData.emptyUploads,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: false,
                        tension: 0.4,
                        borderWidth: 2
                    }, {
                        label: 'Poubelles pleines',
                        data: filteredTimelineData.fullUploads,
                        borderColor: '#f44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        fill: false,
                        tension: 0.4,
                        borderWidth: 2
                    }, {
                        label: 'Total',
                        data: filteredTimelineData.uploads,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        fill: false,
                        tension: 0.4,
                        borderWidth: 3,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Fonction pour filtrer les donn√©es temporelles selon la p√©riode s√©lectionn√©e
        function filterTimelineData(data, days) {
            if (!data.dates || data.dates.length === 0) {
                return { dates: [], uploads: [], emptyUploads: [], fullUploads: [] };
            }
            
            // Calculer la date limite (il y a X jours)
            const today = new Date();
            today.setHours(23, 59, 59, 999); // Fin de la journ√©e actuelle
            const cutoffDate = new Date(today.getTime() - (days * 24 * 60 * 60 * 1000));
            cutoffDate.setHours(0, 0, 0, 0); // D√©but de la journ√©e limite
            
            console.log(`Filtrage des ${days} derniers jours:`);
            console.log(`Date limite: ${cutoffDate.toISOString().split('T')[0]}`);
            console.log(`Date actuelle: ${today.toISOString().split('T')[0]}`);
            
            // Filtrer les donn√©es
            const filteredData = {
                dates: [],
                uploads: [],
                emptyUploads: [],
                fullUploads: []
            };
            
            data.dates.forEach((dateStr, index) => {
                // Essayer diff√©rents formats de date
                let date;
                if (dateStr.includes('/')) {
                    // Format DD/MM/YYYY ou MM/DD/YYYY
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        // Assumons DD/MM/YYYY (format fran√ßais)
                        date = new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                } else if (dateStr.includes('-')) {
                    // Format YYYY-MM-DD
                    date = new Date(dateStr);
                } else {
                    // Essayer de parser directement
                    date = new Date(dateStr);
                }
                
                // V√©rifier si la date est valide et dans la plage
                if (date && !isNaN(date.getTime()) && date >= cutoffDate && date <= today) {
                    filteredData.dates.push(dateStr);
                    filteredData.uploads.push(data.uploads[index] || 0);
                    filteredData.emptyUploads.push(data.emptyUploads[index] || 0);
                    filteredData.fullUploads.push(data.fullUploads[index] || 0);
                }
            });
            
            console.log(`Donn√©es filtr√©es: ${filteredData.dates.length} jours sur ${data.dates.length}`);
            console.log(`Dates incluses:`, filteredData.dates);
            
            return filteredData;
        }

        // G√©n√©ration des zones √† risque avec scroll optimis√©
        function generateRiskZones() {
            const riskZonesList = document.getElementById('riskZonesList');
            
            // Vider les anciennes zones √† risque
            riskZonesList.innerHTML = '';
            
            // Trier les zones par niveau de risque (high > medium > low) puis par pourcentage
            const sortedZones = [...riskZones].sort((a, b) => {
                const riskOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                if (riskOrder[a.level] !== riskOrder[b.level]) {
                    return riskOrder[b.level] - riskOrder[a.level];
                }
                return (b.fullPercentage || 0) - (a.fullPercentage || 0);
            });
            
            sortedZones.forEach((zone, index) => {
                const riskItem = document.createElement('div');
                riskItem.className = `risk-zone-item risk-zone-${zone.level}`;
                riskItem.style.cssText = `
                    margin-bottom: 8px;
                    padding: 12px;
                    border-radius: 8px;
                    border-left: 4px solid ${zone.level === 'high' ? '#f44336' : zone.level === 'medium' ? '#ff9800' : '#4caf50'};
                    background: ${zone.level === 'high' ? 'rgba(244, 67, 54, 0.05)' : zone.level === 'medium' ? 'rgba(255, 152, 0, 0.05)' : 'rgba(76, 175, 80, 0.05)'};
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    transition: all 0.3s ease;
                    min-height: 70px;
                `;
                
                riskItem.innerHTML = `
                    <div style="flex: 1;">
                        <strong style="font-size: 14px; color: #333;">${zone.location}</strong><br>
                        <small style="color: #666; line-height: 1.3;">
                            ${zone.count} poubelles (${zone.fullCount} pleines, ${zone.emptyCount} vides)<br>
                            <span style="font-weight: bold; color: ${zone.level === 'high' ? '#f44336' : zone.level === 'medium' ? '#ff9800' : '#4caf50'};">
                                ${zone.fullPercentage}% pleines
                            </span>
                        </small><br>
                        <small style="color: #999; font-size: 11px;">Derni√®re mise √† jour: ${zone.lastUpdate}</small>
                    </div>
                    <div class="risk-level risk-${zone.level}" style="
                        padding: 6px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: bold;
                        color: white;
                        background: ${zone.level === 'high' ? '#f44336' : zone.level === 'medium' ? '#ff9800' : '#4caf50'};
                        min-width: 60px;
                        text-align: center;
                    ">
                        ${zone.level === 'high' ? '√âlev√©' : zone.level === 'medium' ? 'Moyen' : 'Faible'}
                    </div>
                `;
                
                // Ajouter un effet hover
                riskItem.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateX(2px)';
                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
                });
                
                riskItem.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateX(0)';
                    this.style.boxShadow = 'none';
                });
                
                riskZonesList.appendChild(riskItem);
            });
            
            // Ajouter un style pour la scrollbar si n√©cessaire
            if (riskZones.length > 4) {
                riskZonesList.style.cssText += `
                    scrollbar-width: thin;
                    scrollbar-color: #ccc transparent;
                `;
                
                // Ajouter les styles pour WebKit (Chrome, Safari)
                const style = document.createElement('style');
                style.textContent = `
                    #riskZonesList::-webkit-scrollbar {
                        width: 6px;
                    }
                    #riskZonesList::-webkit-scrollbar-track {
                        background: transparent;
                    }
                    #riskZonesList::-webkit-scrollbar-thumb {
                        background: #ccc;
                        border-radius: 3px;
                    }
                    #riskZonesList::-webkit-scrollbar-thumb:hover {
                        background: #999;
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // G√©n√©ration de l'historique avec filtrage
        function generateHistory() {
            const historyList = document.getElementById('historyList');
            const statusFilter = document.getElementById('statusFilter').value;
            const locationFilter = document.getElementById('locationHistoryFilter').value;
            
            historyList.innerHTML = '';
            
            // Si pas de donn√©es, afficher un message
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = '<div class="history-item"><div class="history-info">Aucune donn√©e disponible</div></div>';
                return;
            }
            
            let filteredHistory = historyData.filter(item => {
                const statusMatch = statusFilter === 'all' || item.status === statusFilter;
                const locationMatch = locationFilter === 'all' || item.location === locationFilter;
                return statusMatch && locationMatch;
            });
            
            // Mettre √† jour les options de localisation bas√©es sur les vraies donn√©es
            updateLocationOptions();
            
            filteredHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-info">
                        <div class="history-filename">${item.filename}</div>
                        <div class="history-details">${item.location} ‚Ä¢ ${item.timestamp} ‚Ä¢ ${item.fileSize} MB</div>
                    </div>
                    <div class="history-status status-${item.status}">
                        ${item.status === 'full' ? 'Pleine' : 'Vide'}
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // Mettre √† jour les options de localisation dans le filtre
        function updateLocationOptions() {
            const locationSelect = document.getElementById('locationHistoryFilter');
            const currentValue = locationSelect.value;
            
            // R√©cup√©rer toutes les localisations uniques des vraies donn√©es
            const locations = [...new Set(historyData.map(item => item.location))];
            
            // Vider et repeupler les options
            locationSelect.innerHTML = '<option value="all">Toutes les locations</option>';
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
            
            // Restaurer la valeur s√©lectionn√©e si elle existe toujours
            if (locations.includes(currentValue)) {
                locationSelect.value = currentValue;
            }
        }

        // Mise √† jour des statistiques
        function updateStats() {
            document.getElementById('total-uploads').textContent = uploadStats.totalUploads || 0;
            document.getElementById('total-bins').textContent = uploadStats.totalBins || 0;
            document.getElementById('avg-file-size').textContent = (uploadStats.avgFileSize || 0) + ' MB';
            
            // Mettre √† jour le combined-percentage avec les vraies donn√©es
            const emptyPercentage = uploadStats.emptyPercentage || 0;
            const fullPercentage = uploadStats.fullPercentage || 0;
            document.getElementById('combined-percentage').textContent = `${emptyPercentage}% / ${fullPercentage}%`;
        }

        // Fonction pour rafra√Æchir le dashboard
        async function refreshDashboard() {
            console.log('Rafra√Æchissement du dashboard...');
            await loadDashboardData();
            
            // Mettre √† jour tous les composants
            updateMapMarkers();
            initChart();
            initLocationChart();
            initTimelineChart();
            generateRiskZones();
            generateHistory();
            updateStats();
            
            console.log('Dashboard rafra√Æchi avec succ√®s');
        }

        // Gestionnaires d'√©v√©nements pour les filtres
        function setupEventListeners() {
            document.getElementById('locationFilter').addEventListener('change', updateMapMarkers);
            document.getElementById('startDate').addEventListener('change', updateMapMarkers);
            document.getElementById('endDate').addEventListener('change', updateMapMarkers);
            document.getElementById('statusFilter').addEventListener('change', generateHistory);
            document.getElementById('locationHistoryFilter').addEventListener('change', generateHistory);
            document.getElementById('timelineFilter').addEventListener('change', initTimelineChart);
        }

        // Exposer la fonction de rafra√Æchissement globalement
        window.refreshDashboard = refreshDashboard;

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', async function() {
            // Charger les donn√©es r√©elles depuis l'API
            await loadDashboardData();
            
            // Initialiser tous les composants avec les vraies donn√©es
            initMap();
            initChart();
            initLocationChart();
            initTimelineChart();
            generateRiskZones();
            generateHistory();
            updateStats();
            setupEventListeners();
        });
    </script>
    <script src="static/js/header-effects.js"></script>
</body>
</html>