<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TrashTrack</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="images/Logo_TrashTrack.png" alt="TrashTrack" class="logo-img">
            </div>
            <nav class="nav">
                <a href="/" class="nav-link">Accueil</a>
                <a href="/dashboard.html" class="nav-link">Dashboard</a>
                <a href="/apropos.html" class="nav-link">√Ä propos</a>
                <a href="/historique" class="nav-link">Historique</a>
                <a href="/contact.html" class="nav-link">Contact</a>
            </nav>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="dashboard-grid">
                <!-- Carte -->
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">üó∫Ô∏è</span>
                        Localisation des Poubelles
                    </h2>
                    <div class="filter-controls">
                        <select class="filter-select" id="locationFilter">
                            <option value="all">Toutes les zones</option>
                            <option value="high-risk">Zones √† haut risque</option>
                            <option value="medium-risk">Zones √† risque moyen</option>
                            <option value="low-risk">Zones √† faible risque</option>
                        </select>
                        <div class="date-range">
                            <label>Du:</label>
                            <input type="date" class="date-input" id="startDate" value="2025-06-01">
                            <label>Au:</label>
                            <input type="date" class="date-input" id="endDate" value="2025-12-31">
                        </div>
                    </div>
                    <div id="map"></div>
                    <div class="risk-zones">
                        <h3>Zones √† Risque de D√©bordement</h3>
                        <div id="riskZonesList"></div>
                    </div>
                </div>
                
                <!-- Statistiques -->
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">üìä</span>
                        Statistiques Globales
                    </h2>
                    <div class="upload-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-uploads">312</span>
                            <div class="stat-label">Images Upload√©es</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="total-bins">24</span>
                            <div class="stat-label">Poubelles Totales</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="avg-file-size">2.4 MB</span>
                            <div class="stat-label">Taille Moyenne</div>
                        </div>
                    </div>
                    
                    <div class="percentage-display">
                        <div class="percentage-item">
                            <span class="percentage-value percentage-empty" id="empty-percentage">67%</span>
                            <div class="stat-label">Vides</div>
                        </div>
                        <div class="percentage-item">
                            <span class="percentage-value percentage-full" id="full-percentage">33%</span>
                            <div class="stat-label">Pleines</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="binChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Graphiques d'analyse -->
            <div class="analytics-grid">
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">üìà</span>
                        Distribution des Tailles de Fichiers
                    </h2>
                    <div class="chart-container file-size-chart">
                        <canvas id="fileSizeChart"></canvas>
                    </div>
                </div>
                
                <div class="dashboard-card">
                    <h2 class="card-title">
                        <span class="card-icon">üìÖ</span>
                        √âvolution Temporelle
                    </h2>
                    <div class="chart-container file-size-chart">
                        <canvas id="timelineChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Historique -->
            <div class="dashboard-card history-section">
                <h2 class="card-title">
                    <span class="card-icon">üìã</span>
                    Historique des Images Trait√©es
                </h2>
                <div class="filter-controls">
                    <select class="filter-select" id="statusFilter">
                        <option value="all">Tous les statuts</option>
                        <option value="empty">Vides uniquement</option>
                        <option value="full">Pleines uniquement</option>
                    </select>
                    <select class="filter-select" id="locationHistoryFilter">
                        <option value="all">Toutes les locations</option>
                        <option value="Paris 15e">Paris 15e</option>
                        <option value="Paris 16e">Paris 16e</option>
                        <option value="Paris 17e">Paris 17e</option>
                    </select>
                </div>
                <div class="history-list" id="historyList">
                        <!-- L'historique sera g√©n√©r√© dynamiquement -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <img src="images/Logo_TrashTrack_Gris.png" alt="TrashTrack" class="logo-img">
                    </div>
                    <div class="social-icons">
                        <a href="https://github.com/AdrienAssd/Trash_Track" class="social-icon">
                            <img src="images/github_blanc.png" alt="GitHub" style="height: 24px; width: 24px;">
                        </a>
                        <a href="#" class="social-icon">üì∑</a>
                        <a href="#" class="social-icon">üé•‚Äã</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h3>Notre √©quipe</h3>
                    <ul>
                        <li><a href="https://www.linkedin.com/in/alexandre-munier-a9a8a9251/">Alexandre MUNIER</a></li>
                        <li><a href="https://www.linkedin.com/in/thibault-bial/">Thibault BIAL</a></li>
                        <li><a href="https://www.linkedin.com/in/adrien-assouad-94a047252/">Adrien ASSOUAD</a></li>
                        <li><a href="https://www.linkedin.com/in/malo-clement-751666253/">Malo CLEMENT</a></li>
                        <li><a href="https://www.linkedin.com/in/fabio-scaramuzzino-314139252/">Fabio SCARAMUZZINO</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Technologies utilis√©es</h3>
                    <ul>
                        <li><a href="#">Python</a></li>
                        <li><a href="#">NumPy / Matplotlib / OpenCV</a></li>
                        <li><a href="#">HTML / CSS</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h3>Resources</h3>
                    <ul>
                        <li><a href="Master_camp-Data_Final.pdf" target="_blank">PDF-Consigne</a></li>
                        <li><a href="https://github.com/AGhaziBla/Solution_Factory_Data/tree/main">GitHub-Consigne</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Variables globales pour stocker les donn√©es r√©elles
        let dashboardData = null;
        let binData = { empty: 0, full: 0 };
        let uploadStats = {};
        let fileSizeData = {};
        let timelineData = {};
        let riskZones = [];
        let historyData = [];

        // Fonction pour charger les donn√©es depuis l'API
        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard-data');
                dashboardData = await response.json();
                
                // Mettre √† jour les variables globales avec les vraies donn√©es
                binData = {
                    empty: dashboardData.stats.emptyCount,
                    full: dashboardData.stats.fullCount
                };
                
                uploadStats = dashboardData.stats;
                fileSizeData = dashboardData.fileSizeData;
                timelineData = dashboardData.timelineData;
                riskZones = dashboardData.riskZones;
                historyData = dashboardData.historyData;
                
                console.log('Donn√©es du dashboard charg√©es:', dashboardData);
                return true;
            } catch (error) {
                console.error('Erreur lors du chargement des donn√©es:', error);
                // Utiliser des donn√©es par d√©faut en cas d'erreur
                initDefaultData();
                return false;
            }
        }

        // Donn√©es par d√©faut en cas d'erreur de chargement
        function initDefaultData() {
            binData = { empty: 0, full: 0 };
            uploadStats = {
                totalUploads: 0,
                totalBins: 0,
                avgFileSize: 0,
                emptyPercentage: 0,
                fullPercentage: 0
            };
            fileSizeData = {
                ranges: ['< 1MB', '1-2MB', '2-3MB', '3-4MB', '> 4MB'],
                counts: [0, 0, 0, 0, 0]
            };
            timelineData = {
                dates: [],
                uploads: []
            };
            riskZones = [];
            historyData = [];
        }

        let currentMap;
        let currentMarkers = [];

        // Initialisation de la carte avec zones √† risque
        function initMap() {
            currentMap = L.map('map').setView([48.8566, 2.3522], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(currentMap);

            updateMapMarkers();
        }

        // Mise √† jour des marqueurs sur la carte
        function updateMapMarkers() {
            // Supprimer les anciens marqueurs
            currentMarkers.forEach(marker => currentMap.removeLayer(marker));
            currentMarkers = [];

            const locationFilter = document.getElementById('locationFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            // Filtrer les donn√©es selon les crit√®res
            let filteredData = historyData.filter(item => {
                const itemDate = item.timestamp.split(' ')[0];
                return itemDate >= startDate && itemDate <= endDate;
            });

            // Ajouter des marqueurs pour chaque poubelle
            filteredData.forEach(item => {
                const riskLevel = getRiskLevel(item.location);
                
                // Appliquer le filtre de zone √† risque seulement si ce n'est pas "all"
                if (locationFilter !== 'all' && !matchesRiskFilter(riskLevel, locationFilter)) {
                    return;
                }

                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: item.status === 'full' ? 'üóëÔ∏è' : '‚ôªÔ∏è',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker([item.lat, item.lng], { icon: icon }).addTo(currentMap);
                currentMarkers.push(marker);
                
                marker.bindPopup(`
                    <div style="text-align: center;">
                        <strong>${item.location}</strong><br>
                        <span style="color: ${item.status === 'full' ? '#c62828' : '#2e7d32'}">
                            ${item.status === 'full' ? 'Pleine' : 'Vide'}
                        </span><br>
                        <small>${item.timestamp}</small><br>
                        <small>Taille: ${item.fileSize} MB</small>
                    </div>
                `);
            });
            
            console.log(`Marqueurs affich√©s: ${currentMarkers.length}/${filteredData.length}`);
        }

        // Obtenir le niveau de risque pour une localisation
        function getRiskLevel(location) {
            const zone = riskZones.find(z => z.location === location);
            return zone ? zone.level : 'low';
        }

        // V√©rifier si le niveau de risque correspond au filtre
        function matchesRiskFilter(riskLevel, filter) {
            return filter === `${riskLevel}-risk`;
        }

        // Initialisation du graphique principal (donut)
        function initChart() {
            const ctx = document.getElementById('binChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Vides', 'Pleines'],
                    datasets: [{
                        data: [binData.empty, binData.full],
                        backgroundColor: [
                            '#4CAF50',
                            '#FF5722'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Graphique de distribution des tailles de fichiers
        function initFileSizeChart() {
            const ctx = document.getElementById('fileSizeChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fileSizeData.ranges,
                    datasets: [{
                        label: 'Nombre d\'images',
                        data: fileSizeData.counts,
                        backgroundColor: '#4CAF50',
                        borderColor: '#388E3C',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Graphique d'√©volution temporelle
        function initTimelineChart() {
            const ctx = document.getElementById('timelineChart').getContext('2d');
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timelineData.dates,
                    datasets: [{
                        label: 'Images upload√©es',
                        data: timelineData.uploads,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // G√©n√©ration des zones √† risque
        function generateRiskZones() {
            const riskZonesList = document.getElementById('riskZonesList');
            
            // Vider les anciennes zones √† risque
            riskZonesList.innerHTML = '';
            
            riskZones.forEach(zone => {
                const riskItem = document.createElement('div');
                riskItem.className = `risk-zone-item risk-zone-${zone.level}`;
                riskItem.innerHTML = `
                    <div>
                        <strong>${zone.location}</strong><br>
                        <small>${zone.count} poubelles ‚Ä¢ ${zone.lastUpdate}</small>
                    </div>
                    <div class="risk-level risk-${zone.level}">
                        ${zone.level === 'high' ? '√âlev√©' : zone.level === 'medium' ? 'Moyen' : 'Faible'}
                    </div>
                `;
                riskZonesList.appendChild(riskItem);
            });
        }

        // G√©n√©ration de l'historique avec filtrage
        function generateHistory() {
            const historyList = document.getElementById('historyList');
            const statusFilter = document.getElementById('statusFilter').value;
            const locationFilter = document.getElementById('locationHistoryFilter').value;
            
            historyList.innerHTML = '';
            
            // Si pas de donn√©es, afficher un message
            if (!historyData || historyData.length === 0) {
                historyList.innerHTML = '<div class="history-item"><div class="history-info">Aucune donn√©e disponible</div></div>';
                return;
            }
            
            let filteredHistory = historyData.filter(item => {
                const statusMatch = statusFilter === 'all' || item.status === statusFilter;
                const locationMatch = locationFilter === 'all' || item.location === locationFilter;
                return statusMatch && locationMatch;
            });
            
            // Mettre √† jour les options de localisation bas√©es sur les vraies donn√©es
            updateLocationOptions();
            
            filteredHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                historyItem.innerHTML = `
                    <div class="history-info">
                        <div class="history-filename">${item.filename}</div>
                        <div class="history-details">${item.location} ‚Ä¢ ${item.timestamp} ‚Ä¢ ${item.fileSize} MB</div>
                    </div>
                    <div class="history-status status-${item.status}">
                        ${item.status === 'full' ? 'Pleine' : 'Vide'}
                    </div>
                `;
                historyList.appendChild(historyItem);
            });
        }

        // Mettre √† jour les options de localisation dans le filtre
        function updateLocationOptions() {
            const locationSelect = document.getElementById('locationHistoryFilter');
            const currentValue = locationSelect.value;
            
            // R√©cup√©rer toutes les localisations uniques des vraies donn√©es
            const locations = [...new Set(historyData.map(item => item.location))];
            
            // Vider et repeupler les options
            locationSelect.innerHTML = '<option value="all">Toutes les locations</option>';
            locations.forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationSelect.appendChild(option);
            });
            
            // Restaurer la valeur s√©lectionn√©e si elle existe toujours
            if (locations.includes(currentValue)) {
                locationSelect.value = currentValue;
            }
        }

        // Mise √† jour des statistiques
        function updateStats() {
            document.getElementById('total-uploads').textContent = uploadStats.totalUploads || 0;
            document.getElementById('total-bins').textContent = uploadStats.totalBins || 0;
            document.getElementById('avg-file-size').textContent = (uploadStats.avgFileSize || 0) + ' MB';
            document.getElementById('empty-percentage').textContent = (uploadStats.emptyPercentage || 0) + '%';
            document.getElementById('full-percentage').textContent = (uploadStats.fullPercentage || 0) + '%';
        }

        // Gestionnaires d'√©v√©nements pour les filtres
        function setupEventListeners() {
            document.getElementById('locationFilter').addEventListener('change', updateMapMarkers);
            document.getElementById('startDate').addEventListener('change', updateMapMarkers);
            document.getElementById('endDate').addEventListener('change', updateMapMarkers);
            document.getElementById('statusFilter').addEventListener('change', generateHistory);
            document.getElementById('locationHistoryFilter').addEventListener('change', generateHistory);
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', async function() {
            // Charger les donn√©es r√©elles depuis l'API
            await loadDashboardData();
            
            // Initialiser tous les composants avec les vraies donn√©es
            initMap();
            initChart();
            initFileSizeChart();
            initTimelineChart();
            generateRiskZones();
            generateHistory();
            updateStats();
            setupEventListeners();
        });
    </script>
</body>
</html>